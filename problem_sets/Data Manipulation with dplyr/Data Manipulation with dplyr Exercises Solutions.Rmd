
---
title: 'Problem Set 04: Data Manipulation with dplyr'
author: "Will Hopper"
output:
  html_document:
    theme: lumen
    toc: yes
    toc_float: yes
    toc_level: 2
    df_print: kable
    self_contained: true
editor_options: 
  chunk_output_type: console
---

<!-- PLEASE DONT TOUCH ANY OF THE STYLING CODE BELOW -->
<style type="text/css">
body {
  counter-reset: exercises toc; /* initialize counters */
  font-size: 18px;
}
.col-md-3 { width: 12%; }

#TOC { width: 65%; max-width: 130px; }

.col-md-9 { width: 88%; }

p { margin: 5px 0;}

img {margin: 5px 0;}

ol li, ul li { list-style-position: inside; }

div[id^='exercise'] { background:rgba(49, 126, 172, 0.1); }

div[id^='exercise'] > h2 {
  font-weight: bold;
  color: #fff;
  background:#317EAC;
  padding: 5px 10px;
}

div[id^='exercise'] > h2::after {
  content: " " counter(exercises);
  counter-increment: exercises;
}

.tocify-header > li:after {
    content: " " counter(toc); /* Use the counter as content */
    counter-increment: toc; /* Increment the counter by 1 */
}

.level3 {
  background: #fff;
  padding-top: 15px;
  margin-bottom: 0;
}

.level3 > h3 { margin: 0;}

.attention { 
  color: #000;
  border: 2px solid #ff2e2e;
  padding: 10px 10px;
  background-color: rgb(255, 110, 110);
  border-radius: 5px;
}

.table {width: inherit;}
</style>

<!-- Exercises begin below -->

In this problem set, we will practice some of the key data manipulation tasks using the tools from the `dplyr` package.

### Libraries
```{r warning = F, message = F}
library(ggplot2)
library(dplyr)
```

### The data
You will be working with the `txhousing` data set, which is included in the `ggplot2` package and will be loaded when you use `library(ggplot2)`. Take a peek at the dataset below, taking note of the data types of each variable:

```{r}
glimpse(txhousing)
```

This data set has **monthly** observations of the housing market in 46 regions of Texas from the years 2000 through 2015. The `city`, `year`, `month` and `date` variables identify the city, month, year, and exact date of the observation, and the measured variables are for each observation are:

- `sales`: Number of sales
- `volume`: Total value of sales
- `median`: Median sale price
- `listings`: Total number of homes listed for sale
- `inventory`: A "Months inventory", a.k.a, the amount of time it would take to sell all current listings at current pace of sales.

<div class="attention">
For each problem below, always print out the final data frame or vector that gives you the answer to the question.
</div>

## Exercise
Remove the `date` variable from the data frame, rename the `median` variable to `median_price`. Be sure to overwrite the original data frame with your results.

### Solution
```{r}
txhousing <- select(txhousing, -date)
txhousing <- rename(txhousing, median_price = median)
head(txhousing, 3)
```


## Exercise
Remove any rows of the `txhousing` data set with missing values in the `sales` variable, and overwrite the original data frame. Then use the `anyNA()` function on the `sales` variable, e.g., `anyNA(txhousing$sales)`. If you were successful, this should print out `FALSE`.

### Solution
```{r}
txhousing <- filter(txhousing, !is.na(sales))
anyNA(txhousing$sales)
```


## Exercise
Make a data set called `dallas` that includes data only from the city of Dallas in the years 2000 through 2010. Test to see if your results are correct by using the `distinct` function to show the unique city and year combinations in your data frame.

### Solution
```{r}
dallas <- filter(txhousing, year %in% 2000:2010, city =="Dallas")
distinct(dallas, city, year)
```


## Exercise
What are the median sales volume and the total sales volume for homes in Dallas, across all months and years in the `dallas` data frame? Your solution should present both answers in the same data frame (no need to save the output here). Remember, you can compute the median value with the `median` function.

### Solution
```{r}
summarise(dallas,
          median_volume = median(volume),
          total_volume = sum(volume)
          )
```


## Exercise
Compute the total sales volume for each year in the `dallas` data frame. Save this output as a new data frame called `dallas_annual_volume`.

*Hint: The correct solution will create a data frame with 11 rows; one row for 2000, one row for 2001, one row for 2002, etc.)*

### Solution
```{r}
dallas_annual_volume <- group_by(dallas, year) %>%
  summarise(volume = sum(volume))
dallas_annual_volume
```


## Exercise:
Which year in the had the lowest sales volume in the  `dallas_annual_volume` data frame? Your solution should print out the single row of the data frame that corresponds to this year. No need to save the results.

### Solution
Here's one way to do it: filter the rows that match the minimum values.
```{r, top_year_solution1}
# Solution 1
filter(dallas_annual_volume,
       volume == min(dallas_annual_volume$volume)
       )
```

Here's another way: sort the rows by volume, from largest to smallest, and slice the first row from the sorted data frame.
```{r}
# Solution 2
arrange(dallas_annual_volume, volume)[1, ]
```


## Exercise
Using `ggplot`, visualize the sales volume per year from the `dallas_annual_volume` data frame. Describe the pattern of sales volumes over time.

**Hints: Any variable representing time usually goes on the x axis of a figure. You can use the geom_point() function to draw individual points on a plot, and the `geom_line() function to connect the points**

### Solution 
```{r}
ggplot(dallas_annual_volume, aes(x=year, y=volume)) +
  geom_point() +
  geom_line()
```

Sales volume peaked in 2006-2007, and then fell sharply in 2008 with the onset of the financial crisis.

## Exercise
Add a column to the `txhousing` data set called `houses_left` that calculates the difference between the number of homes listed for sale and the number of homes actually sold at the end of the month. Be sure to save the `txhousing` data frame with this new column. 

### Solution
```{r}
txhousing <- mutate(txhousing, houses_left = listings - sales)
head(txhousing, 3)
```


## Exercise
Which city had the highest sales volume over the entire period recorded in the `txhousing` dataset? Which city had the most sales? Are they the same city?


### Solution
```{r}
x <- txhousing %>%
  group_by(city) %>%
  summarise(volume = sum(volume),
            sales = sum(sales)
            )
arrange(x, desc(volume))[1,]
arrange(x, desc(sales))[1,]
```

Houston had both the most sales and highest sales volume.

## Exercise
Generate a single table that shows the total number of houses sold in Austin and Dallas over the period of years 2000 and 2001.

### Solution

**Note:** It has been pointed out to me that this question is somewhat ambiguous, and "in Austin and Dallas" could reasonably be construed as asking for the total number of sales pooled across the two cities instead of the number of *within* each city. In other words, asking for one total value instead of two. In light of this ambiguity, I will accept either of the following answers:

```{r }
txhousing %>% 
  filter(city == "Austin"| city == "Dallas",
         year == 2000 | year == 2001) %>%
  group_by(city) %>%
  summarize(total_sales = sum(sales))
```

```{r}
txhousing %>% 
  filter(city == "Austin"| city == "Dallas",
         year == 2000 | year == 2001) %>%
  summarize(total_sales = sum(sales))
```
